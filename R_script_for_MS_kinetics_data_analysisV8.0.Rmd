---
title: "MS_kinetics_data_analysis"
output: html_notebook
---

```{r}
library(tidyverse)
# All input files must be in comma-separated value format (.csv). 

#The R script is built to analyze 3 files from experiments performed under the same conditions with the same enzyme that the user desires to be analyzed and summarized together. If there are a different number of files than 3 from the same conditions with the same enzyme, the R script can be adjusted. To increase or decrease the number of replicate trials, go to lines 94 and 114. At these lines, add additional trials by adding "T4", "T5," etc. After the "T3," but before "average."  Then repeat the same function at lines 178 and 179. 


# Input section
## read in skyline output file
skyline_output<-as.data.frame(read.csv2(file.choose(),header=TRUE, sep=",")) 

## read in master MZ file containing all of the ions and their status as either dephosphorylated (D) or phosphorylated (P)
MZ<-as.data.frame(read.csv2(file.choose(),header=TRUE, sep=",")) 

## import ionization correction factor csv file 
cf<-as.data.frame(read.csv2(file.choose(),header=TRUE, sep=","))

## import peptide ids file
ID<-as.data.frame(read.csv2(file.choose(),header=TRUE, sep=",")) 

#Input the following reaction parameters:
##Reaction time in minutes
min= 40 

##Reaction concentration in Nanomolar 
nM= 1000


#Input the desire output locations: 

## Define path for cleaned skyline files 
input_location= "C:/Users/andre/OneDrive/Desktop/R_temp_/R_temp_for_calculations/" 


##Define output path for kcat/km calculation files 
output_file_Sr= "C:/Users/andre/OneDrive/Desktop/R_temp_/R_temp_for_calculations/Sc_Cdc14_1000nM_Sr.csv"

output_file_kcat.km="C:/Users/andre/OneDrive/Desktop/R_temp_/R_temp_for_calculations/Sc_Cdc14_1000nM_kcat.km.csv"

output_file_summary="C:/Users/andre/OneDrive/Desktop/R_temp_/R_temp_for_calculations/Sc_Cdc14_1000nM_summary.csv"

#end of input section
kinetics <- function(file,min,conc){
  #this function calculates kinetic values for the peptide series 
  y <- (min*60)# time in minutes
  k <- (conc*(1E-9)) #concentration in nM
  # step 1: reorganize the data 
  temp <- file
  tempsplit <- split(temp,temp["Status"])
  tempsplit[["D"]]->D 
  tempsplit[["P"]]->P
  D.1<- select(D,-c("Protein.Name.x") )
  P.1 <- select(P,-c("Protein.Name.x") )
  temp <- merge(D.1,P.1, by.x=c("Protein.Name.y"), by.y=c("Protein.Name.y"), all.x=TRUE, all.y=TRUE)
  temp<-mutate(temp, "Enzyme_concentration_(M)" = k )# add column for enzyme concentration
  temp<-mutate(temp, "Time_(sec)" = y ) # add column for time
  a <- (as.numeric(temp[["peak.area.corrected.x"]])) # dephosporylated peak area
  b <- (as.numeric(temp[["peak.area.corrected.y"]])) # phosporylated peak area
  # step 2 calculate 
  Sr<-(b/(a+b))
  temp<-mutate(temp, "Substrate_remaining" =Sr) #calculate 
  w <-(-log((Sr))/(k*y)) # calculate kcat/km
  temp<-mutate(temp, "Kcat/Km" = w )
  # step 3 output 
  as_tibble(temp)->temp
  return(temp)
}
mycorrector <- function(x){
    # this function cleans the data and adjusts the phospho signal based on the correction factor from the lambda phosphatase data
  temp <- x
  temp1 <- merge(temp,MZ,by.x=c("Protein.Name","Peptide.Modified.Sequence","Precursor.Mz" ), by.y =c("Protein.Name","Peptide.Modified.Sequence","Precursor.Mz"))
  temp2 <- unique(temp1)
  temp3 <- mutate(temp2, "peak.area" = Total.Area.MS1 - Total.Background.MS1)
  temp4 <- select(temp3,-c("Total.Area.MS1","Total.Background.MS1"))
  temp5 <- summarize(group_by(temp4,Protein.Name, Peptide.Modified.Sequence, Status), peak.area_total= sum(peak.area))
  temp6 <- merge(temp5,cf,by.x=c("Peptide.Modified.Sequence" , "Status"),by.y=c("Peptide.Modified.Sequence","Status"), all.x=TRUE, all.y=TRUE)
  temp7 <- mutate(temp6,"peak.area.corrected" = as.numeric(peak.area_total) * as.numeric(Cf))
  temp8 <- select(temp7, -c("peak.area_total","Cf"))
  return(temp8)
}
Sr_summarizer <- function(x){
  # this function calculates summary statistics for the Sr values 
  temp  <- do.call(rbind, x) 
  temp1 <- select(temp, Protein.Name.y, file.y, `Substrate_remaining`) 
  temp2 <- pivot_wider(temp1, names_from=file.y, values_from=`Substrate_remaining`) 
  temp3 <- arrange(temp2, Protein.Name.y)
  my_means <- as.matrix(select(temp3, contains("correct"))) %>% apply(1, mean)
  temp4 <- mutate(temp3, means = my_means)
  my_sd <- as.matrix(select(temp3, contains("correct"))) %>% apply(1, sd)
  temp5 <- mutate(temp4, sd = my_sd)
  name_row2 <- c("Peptide_name","T1","T2","T3","average_Sr","std_Sr")
  colnames(temp5)<- name_row2
  temp5[["average_Sr"]]->average
  temp5[["std_Sr"]]-> std
  cv <- std/average
  temp6<- mutate(temp5, "CV_Sr"=cv)
  temp7<- merge(ID, temp6,by.y = c("Peptide_name"),by.x = c("Protein.name"))
  return(temp7)

}
my_summarizer_kinetics <- function(x){
  # this function calculates summary statistics for the kcat/km values 
  temp  <- do.call(rbind, x) 
  temp1 <- select(temp, Protein.Name.y, file.y, `Kcat/Km`) 
  temp2 <- pivot_wider(temp1, names_from=file.y, values_from=`Kcat/Km`) 
  temp3 <- arrange(temp2, Protein.Name.y)
  my_means <- as.matrix(select(temp3, contains("correct"))) %>% apply(1, mean)
  temp4 <- mutate(temp3, means = my_means)
  my_sd <- as.matrix(select(temp3, contains("correct"))) %>% apply(1, sd)
  temp5 <- mutate(temp4, sd = my_sd)
  name_row2 <- c("Peptide_name","T1","T2","T3","average_kcat/km","std_kcat/km")
  colnames(temp5)<- name_row2
  temp5[["average_kcat/km"]]->average
  temp5[["std_kcat/km"]]-> std
  cv <- std/average
  temp6<- mutate(temp5, "CV_kcat/km"=cv)
  temp7<- merge(ID, temp6,by.y = c("Peptide_name"),by.x = c("Protein.name"))
  return(temp7)
  }


 
skyline_output <- as_tibble(skyline_output)
skyline_output<-select(skyline_output,-c("Retention.Time")) # remove columns 


MZ <- as_tibble(MZ)

cf <- as_tibble(cf)

ID <- as_tibble(ID)


skyline_split <- split(skyline_output, skyline_output$Replicate) # split the skyline file into individual replicates 

# my corrector will identify each M/Z value for each peptide as D or P, and give a single peak area value for each ion, then correct the peak area based on the correction factor 


all_correct <- lapply(skyline_split, mycorrector) # apply the my corrector function across all replicates



for(i in 1:length(all_correct)){
  write_delim(all_correct[[i]], path=str_c("correct_", names(all_correct)[i], "clean.csv", sep=""), delim=",") # output cleaned files 
}




folder <- input_location      # path to folder that holds multiple .csv files
 file_list1 <- list.files(path=folder, pattern="*clean.csv") # create list of all .csv files in folder
  # read in each .csv file in file_list and create a data frame with the same name as the .csv file
 for (i in 1:length(file_list1)){
  assign(file_list1[i], 
  read.csv(paste(folder, file_list1[i], sep=''))
  )}
 
 df_list <- lapply(file_list1, read_delim, delim=",", col_names=TRUE) # add the file name into each individual file as a column in list 1
for(i in 1:length(df_list)){ df_list[[i]]$file <- file_list1[i]}

calculated<- lapply(df_list, kinetics, min, nM) # apply kinetics function each individual file in the sequence 


Kcat.Km <- my_summarizer_kinetics(calculated) # calculate summary statistics for kcat/km

Sr <- Sr_summarizer(calculated)# calculate summary statistics for Sr

# be sure to change the names of the output files here/below!!!

write_delim(Sr, path=output_file_Sr ,delim = ",",col_names = TRUE)

write_delim(Kcat.Km, path=output_file_kcat.km ,delim = ",",col_names = TRUE)


Kcat.Km_f <- select(Kcat.Km, -c("T1","T2","T3"))
Sr_f <- select(Sr, -c("T1","T2","T3"))


summarized_table<-merge(Sr_f,Kcat.Km_f, by.x = c("Protein.name","Sequence"), by.y =  c("Protein.name","Sequence"))

write_delim(summarized_table, path=output_file_summary,delim = ",",col_names = TRUE)

```